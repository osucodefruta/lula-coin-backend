<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lula Coin Miner</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        /* Variáveis CSS para fácil tematização */
        :root {
            --primary-color: #ff3b3b; /* Vermelho Neon */
            --secondary-color: #2e008a; /* Azul Escuro */
            --tertiary-color: #0a0e2a; /* Azul Quase Preto */
            --text-color: #e0e0e0;
            --dark-gray: #1a1a1a;
            --medium-gray: #333;
            --light-gray: #555;
            --red-alert: #ff4500;
            --border-color: rgba(255, 59, 59, 0.3);
            --glow-color: rgba(255, 59, 59, 0.6);

            /* Cores para o ambiente do galpão */
            --wall-color-dark: #3a4750;
            --wall-color-light: #4a5c68;
            --floor-color: #2c3e50;
            --rack-color: #222;
            --rack-glow-color: rgba(255, 59, 59, 0.5);
        }

        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: var(--dark-gray);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; /* Para as partículas */
            position: relative;
        }

        /* Estilos do Hangar / Sala de Mineração */
        .mining-room {
            position: relative;
            width: 90vw;
            height: 80vh;
            background: linear-gradient(to bottom, var(--wall-color-dark), var(--wall-color-light), var(--floor-color));
            border: 2px solid var(--border-color);
            box-shadow: 0 0 20px var(--glow-color);
            border-radius: 8px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, 1fr);
            gap: 20px;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
            display: none; /* Escondido por padrão, mostrado após login */
            z-index: 1; /* Acima das partículas */
        }

        .rack-container {
            border: 1px solid var(--rack-color);
            background-color: var(--rack-color);
            border-radius: 5px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3); /* Brilho ciano para os racks */
        }

        .rack-title {
            color: var(--primary-color);
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 10px;
            font-size: 0.9em;
            text-align: center;
        }

        .slot {
            width: 80px;
            height: 80px;
            border: 2px dashed rgba(255, 255, 255, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            position: relative;
            background-color: rgba(0, 0, 0, 0.2);
        }

        .slot.occupied {
            border: 2px solid var(--primary-color);
        }

        .slot img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            user-select: none; /* Previne seleção de imagem */
            -webkit-user-drag: none; /* Previne arrastar imagem */
        }

        /* Estilos do console de monitoramento */
        .monitor-console {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--primary-color);
            box-shadow: 0 0 15px var(--glow-color);
            padding: 15px;
            border-radius: 5px;
            width: 300px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.8em;
            color: limegreen; /* Cor de terminal */
            z-index: 10;
        }

        #monitor-text {
            white-space: pre-wrap; /* Preserva quebras de linha */
        }

        /* Estilos do Terminal */
        .terminal {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 500px;
            background-color: rgba(0, 0, 0, 0.9);
            border: 1px solid var(--primary-color);
            box-shadow: 0 0 20px var(--glow-color);
            border-radius: 8px;
            padding: 15px;
            z-index: 10; /* Acima de outros elementos */
        }

        .terminal-output {
            height: 150px;
            overflow-y: scroll;
            background-color: #0a0a0a;
            border: 1px solid #333;
            padding: 10px;
            margin-bottom: 10px;
            font-size: 0.85em;
            color: limegreen;
            white-space: pre-wrap; /* Para quebra de linha */
        }

        .terminal-input-container {
            display: flex;
            align-items: center;
        }

        .terminal-input-container span {
            color: var(--primary-color);
            margin-right: 5px;
            font-size: 0.9em;
        }

        .terminal-input {
            flex-grow: 1;
            background-color: #1a1a1a;
            border: 1px solid var(--primary-color);
            color: limegreen;
            padding: 8px;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.9em;
            outline: none;
        }


        /* Estilos do HUD (canto superior direito) */
        .hud {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--primary-color);
            box-shadow: 0 0 15px var(--glow-color);
            padding: 15px;
            border-radius: 5px;
            z-index: 10;
            text-align: right;
        }

        .hud div {
            margin-bottom: 5px;
        }

        .hud span {
            color: var(--primary-color);
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1em;
        }

        .hud p {
            margin: 0;
            font-size: 0.9em;
        }

        /* Botões de Ação Global (canto inferior direito) */
        .action-buttons {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 10;
        }

        .action-button, .modal-button {
            background-color: var(--primary-color);
            color: var(--tertiary-color);
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 0.9em;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 0 10px var(--glow-color);
            text-transform: uppercase;
        }

        .action-button:hover, .modal-button:hover {
            background-color: #ff6a6a;
            transform: translateY(-2px);
        }

        .action-button:active, .modal-button:active {
            transform: translateY(0);
        }

        /* Estilos de Modais */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0, 0, 0, 0.7); /* Black w/ opacity */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
        }

        .modal-content {
            background-color: var(--dark-gray);
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 25px var(--glow-color);
            padding: 30px;
            border-radius: 8px;
            width: 80%;
            max-width: 600px;
            position: relative;
            text-align: center;
        }

        .close-button {
            color: var(--primary-color);
            font-size: 30px;
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-button:hover,
        .close-button:focus {
            color: #ff6a6a;
            text-decoration: none;
        }

        .modal-title {
            color: var(--primary-color);
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-transform: uppercase;
        }

        .category-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .category-buttons button {
            background-color: var(--medium-gray);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .category-buttons button:hover {
            background-color: var(--light-gray);
        }

        .category-buttons button.active {
            background-color: var(--primary-color);
            color: var(--tertiary-color);
            box-shadow: 0 0 10px var(--glow-color);
        }

        .item-list {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px; /* Para scrollbar */
        }

        .item-card {
            background-color: #1a1a1a;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            width: 150px;
            text-align: center;
            box-shadow: 0 0 8px rgba(0, 255, 255, 0.2);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.5);
        }

        .item-card img {
            width: 80px;
            height: 80px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .item-card h4 {
            margin: 0 0 5px 0;
            color: var(--primary-color);
            font-size: 1.1em;
        }

        .item-card p {
            margin: 0 0 8px 0;
            font-size: 0.85em;
            color: var(--text-color);
        }

        .item-card .cost {
            color: yellow; /* Cor para o custo */
            font-weight: bold;
        }
        .item-card .hashrate {
            color: limegreen; /* Cor para hashrate */
            font-weight: bold;
        }

        .item-card button {
            background-color: var(--primary-color);
            color: var(--tertiary-color);
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            font-size: 0.8em;
            transition: background-color 0.3s;
            margin-top: auto; /* Empurra o botão para baixo */
        }

        .item-card button:hover {
            background-color: #ff6a6a;
        }

        /* Mensagens de Overlay */
        .overlay-message {
            display: none; /* Escondido por padrão */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            font-size: 1.2em;
            text-align: center;
            z-index: 1000; /* Acima de tudo */
            border: 2px solid;
        }

        .overlay-message.info { border-color: #007bff; }
        .overlay-message.success { border-color: #28a745; }
        .overlay-message.error { border-color: var(--red-alert); }

        /* Barra de Seleção de Mineradores (para colocar GPUs) */
        .miner-selection-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            border-top: 2px solid var(--primary-color);
            box-shadow: 0 0 20px var(--glow-color);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 0;
            z-index: 900;
            display: none; /* Escondido por padrão */
        }

        .miner-selection-bar p {
            margin: 0 20px;
            color: var(--text-color);
            font-size: 1.1em;
        }

        .miner-selection-bar button {
            background-color: var(--red-alert);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            transition: background-color 0.3s;
        }

        .miner-selection-bar button:hover {
            background-color: #ff6a6a;
        }

        /* Container de Partículas */
        .particle-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            overflow: hidden;
            z-index: 0; /* Fica abaixo dos outros elementos */
        }

        .particle {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            opacity: 0;
            animation: floatAndFade 5s infinite ease-out;
        }

        @keyframes floatAndFade {
            0% { transform: translateY(0) translateX(0) scale(0); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(-100vh) translateX(50px) scale(1); opacity: 0; }
        }

        /* Estilos para a seção de autenticação */
        .auth-container {
            background-color: var(--tertiary-color);
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 0 30px var(--glow-color);
            text-align: center;
            width: 90%;
            max-width: 400px;
            position: relative;
            z-index: 1; /* Acima das partículas */
        }

        .auth-container h2 {
            color: var(--primary-color);
            font-family: 'Orbitron', sans-serif;
            margin-bottom: 25px;
            font-size: 2em;
        }

        .auth-container form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .auth-container input[type="text"],
        .auth-container input[type="password"] {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--dark-gray);
            color: var(--text-color);
            font-family: 'Share Tech Mono', monospace;
            font-size: 1em;
            outline: none;
        }

        .auth-container input[type="text"]:focus,
        .auth-container input[type="password"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px var(--glow-color);
        }

        .auth-container button {
            background-color: var(--primary-color);
            color: var(--tertiary-color);
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1em;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 0 15px var(--glow-color);
            text-transform: uppercase;
        }

        .auth-container button:hover {
            background-color: #ff6a6a;
            transform: translateY(-2px);
        }

        .auth-container button:active {
            transform: translateY(0);
        }

        .auth-container p {
            margin-top: 20px;
            font-size: 0.9em;
            color: var(--text-color);
        }

        .auth-container a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
            transition: color 0.3s;
        }

        .auth-container a:hover {
            color: #ff6a6a;
        }

        .message-display {
            color: var(--red-alert);
            margin-top: 15px;
            font-size: 0.9em;
        }

        #game-section {
            display: none; /* Inicialmente escondida */
            width: 100%;
            height: 100vh;
            justify-content: center;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        #auth-section {
            display: flex; /* Inicialmente visível */
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100vh;
            z-index: 1;
        }

        /* Estilos do Modal de Saque */
        .withdraw-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .withdraw-form input[type="number"] {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            background-color: var(--dark-gray);
            color: var(--text-color);
            font-family: 'Share Tech Mono', monospace;
            font-size: 1em;
            outline: none;
        }
        .withdraw-form input[type="number"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 8px var(--glow-color);
        }

        /* Rig Manager Modal */
        #rigManagerModal .rig-slot {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #1c1c1c;
            border: 1px solid #444;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
        }

        #rigManagerModal .rig-slot span {
            font-size: 0.9em;
            color: var(--text-color);
        }

        #rigManagerModal .rig-slot button {
            background-color: var(--red-alert);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

    </style>
</head>
<body>
    <div id="overlay-message" class="overlay-message">
        <p id="overlay-message-text"></p>
    </div>

    <section id="auth-section">
        <div class="particle-container" id="particle-container-auth"></div>
        <div class="auth-container">
            <div id="login-form-container">
                <h2>Lula Coin Miner</h2>
                <form id="login-form">
                    <input type="text" id="login-username" placeholder="Usuário" required>
                    <input type="password" id="login-password" placeholder="Senha" required>
                    <button type="submit">Login</button>
                </form>
                <p>Não tem uma conta? <a href="#" id="show-register">Registre-se</a></p>
                <p id="login-message" class="message-display"></p>
            </div>

            <div id="register-form-container" style="display: none;">
                <h2>Registrar</h2>
                <form id="register-form">
                    <input type="text" id="register-username" placeholder="Usuário" required>
                    <input type="password" id="register-password" placeholder="Senha" required>
                    <button type="submit">Registrar</button>
                </form>
                <p>Já tem uma conta? <a href="#" id="show-login">Fazer Login</a></p>
                <p id="register-message" class="message-display"></p>
            </div>
        </div>
    </section>

    <section id="game-section">
        <div class="particle-container" id="particle-container-game"></div>

        <div class="mining-room" id="mining-room">
            <div class="rack-container" id="rack-1">
                <h3 class="rack-title">Rack 1</h3>
                <div class="slot" data-rack="1" data-slot="0"></div>
                <div class="slot" data-rack="1" data-slot="1"></div>
            </div>
            <div class="rack-container" id="rack-2">
                <h3 class="rack-title">Rack 2</h3>
                <div class="slot" data-rack="2" data-slot="0"></div>
                <div class="slot" data-rack="2" data-slot="1"></div>
            </div>
            <div class="rack-container" id="rack-3">
                <h3 class="rack-title">Rack 3</h3>
                <div class="slot" data-rack="3" data-slot="0"></div>
                <div class="slot" data-rack="3" data-slot="1"></div>
            </div>
            <div class="rack-container" id="rack-4">
                <h3 class="rack-title">Rack 4</h3>
                <div class="slot" data-rack="4" data-slot="0"></div>
                <div class="slot" data-rack="4" data-slot="1"></div>
            </div>
            <div class="rack-container" id="rack-5">
                <h3 class="rack-title">Rack 5</h3>
                <div class="slot" data-rack="5" data-slot="0"></div>
                <div class="slot" data-rack="5" data-slot="1"></div>
            </div>
            <div class="rack-container" id="rack-6">
                <h3 class="rack-title">Rack 6</h3>
                <div class="slot" data-rack="6" data-slot="0"></div>
                <div class="slot" data-rack="6" data-slot="1"></div>
            </div>
        </div>

        <div class="monitor-console">
            <pre id="monitor-text">
Lula Coin Miner OS v1.0
Booting...
Connection: OK
Status: Online

Hashrate: 0 H/s
Balance: 0.00 LC
User: Guest
Level: 1
            </pre>
        </div>

        <div class="terminal">
            <div class="terminal-output" id="terminal-output">
                Bem-vindo ao Lula Coin Miner Terminal. Digite 'help' para comandos.
            </div>
            <div class="terminal-input-container">
                <span>></span><input type="text" class="terminal-input" id="terminal-input" autofocus>
            </div>
        </div>

        <div class="hud">
            <p>Usuário: <span id="username-display">Carregando...</span></p>
            <p>Lula Coins: <span id="lula-coins-display">0.00</span></p>
            <p>Hashrate Total: <span id="hashrate-display">0</span> H/s</p>
            <p>Nível Minerador: <span id="level-display">1</span></p>
        </div>

        <div class="action-buttons">
            <button id="miner-button" class="action-button">Minerar!</button>
            <button id="upgrade-miner-button" class="action-button">Upgrade Miner</button>
            <button id="open-shop-btn" class="action-button">Loja</button>
            <button id="open-inventory-btn" class="action-button">Inventário</button>
            <button id="open-rig-manager-btn" class="action-button">Gerenciar Rigs</button>
            <button id="saque-button" class="action-button">Sacar Lula Coins</button>
            <button id="logout-button" class="action-button">Logout</button>
        </div>

        <div id="shopModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="close-shop-btn">&times;</span>
                <h3 class="modal-title">Loja de Itens</h3>
                <div class="category-buttons" id="shop-category-buttons">
                    <button data-category="gpus" class="active">GPUs</button>
                    <button data-category="upgrades">Upgrades</button>
                </div>
                <div id="shop-items-list" class="item-list">
                    </div>
            </div>
        </div>

        <div id="inventoryModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="close-inventory-btn">&times;</span>
                <h3 class="modal-title">Inventário</h3>
                <div class="category-buttons" id="inventory-category-buttons">
                    <button data-category="gpus" class="active">GPUs</button>
                    <button data-category="upgrades">Upgrades</button>
                </div>
                <div id="inventory-items-list" class="item-list">
                    </div>
            </div>
        </div>

        <div id="withdrawModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="close-withdraw-btn">&times;</span>
                <h3 class="modal-title">Sacar Lula Coins</h3>
                <p>Seu saldo atual: <span id="withdraw-current-balance">0.00</span> Lula Coins</p>
                <form id="withdraw-form" class="withdraw-form">
                    <input type="number" id="withdraw-amount" placeholder="Valor do saque" min="0.01" step="0.01" required>
                    <button type="submit" class="modal-button">Confirmar Saque</button>
                </form>
            </div>
        </div>

        <div id="rigManagerModal" class="modal">
            <div class="modal-content">
                <span class="close-button" id="close-rig-manager-btn">&times;</span>
                <h3 class="modal-title">Gerenciar Rigs</h3>
                <div id="rig-slots-list" class="item-list" style="flex-direction: column;">
                    </div>
            </div>
        </div>

        <div id="minerSelectionBar" class="miner-selection-bar">
            <p>Clique em um slot vazio no rack para posicionar a GPU.</p>
            <button id="cancelSelectionBtn">Cancelar Seleção</button>
        </div>

    </section>

    <script src="js/utils.js"></script>
    <script>
        // backend/routes/auth.js
        const API_BASE_URL = 'https://lula-coin-backend.onrender.com'; // Sua URL do backend no Render

        // Referências aos elementos do DOM para autenticação
        const authSection = document.getElementById('auth-section');
        const gameSection = document.getElementById('game-section');

        const loginForm = document.getElementById('login-form');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginMessageDisplay = document.getElementById('login-message');

        const registerForm = document.getElementById('register-form');
        const registerUsernameInput = document.getElementById('register-username');
        const registerPasswordInput = document.getElementById('register-password');
        const registerMessageDisplay = document.getElementById('register-message');

        const showRegisterLink = document.getElementById('show-register');
        const showLoginLink = document.getElementById('show-login');

        // Referências a elementos do DOM do jogo (alguns podem ser repetidos do game.js para clareza aqui)
        const usernameDisplay = document.getElementById('username-display');
        const lulaCoinsDisplay = document.getElementById('lula-coins-display');
        const hashrateDisplay = document.getElementById('hashrate-display');
        const levelDisplay = document.getElementById('level-display');
        const minerButton = document.getElementById('miner-button');
        const upgradeMinerButton = document.getElementById('upgrade-miner-button');
        const openShopBtn = document.getElementById('open-shop-btn');
        const openInventoryBtn = document.getElementById('open-inventory-btn');
        const openRigManagerBtn = document.getElementById('open-rig-manager-btn');
        const saqueButton = document.getElementById('saque-button');
        const logoutButton = document.getElementById('logout-button');
        const monitorText = document.getElementById('monitor-text');
        const terminalInput = document.getElementById('terminal-input');
        const terminalOutput = document.getElementById('terminal-output');

        // Modals e seus botões de fechar
        const shopModal = document.getElementById('shopModal');
        const closeShopBtn = document.getElementById('close-shop-btn');
        const inventoryModal = document.getElementById('inventoryModal');
        const closeInventoryBtn = document.getElementById('close-inventory-btn');
        const withdrawModal = document.getElementById('withdrawModal');
        const closeWithdrawBtn = document.getElementById('close-withdraw-btn');
        const rigManagerModal = document.getElementById('rigManagerModal');
        const closeRigManagerBtn = document.getElementById('close-rig-manager-btn');
        const minerSelectionBar = document.getElementById('minerSelectionBar');
        const cancelSelectionBtn = document.getElementById('cancelSelectionBtn');

        // Formulário de saque
        const withdrawForm = document.getElementById('withdraw-form');
        const withdrawAmountInput = document.getElementById('withdraw-amount');
        const withdrawCurrentBalance = document.getElementById('withdraw-current-balance');

        // Variáveis de estado do jogo (devem ser inicializadas com dados do usuário)
        let lulaCoins = 0;
        let level = 1;
        let minerValue = 1;
        let totalHashrate = 0;
        let inventory = { gpus: [], upgrades: [] };
        let placedGpus = {};
        let isPlacingGpu = false; // Flag para saber se o usuário está em modo de colocação
        let selectedGpuToPlace = null; // Guarda o item do inventário selecionado para colocar

        // Referências aos elementos de racks e slots (do game.js original)
        const rackSlots = document.querySelectorAll('.slot');
        const shopItemsList = document.getElementById('shop-items-list');
        const inventoryItemsList = document.getElementById('inventory-items-list');
        const rigSlotsList = document.getElementById('rig-slots-list'); // Novo para o Rig Manager

        // Categorias de Loja e Inventário
        const shopCategoryButtons = document.querySelectorAll('#shopModal .category-buttons button');
        const inventoryCategoryButtons = document.querySelectorAll('#inventoryModal .category-buttons button');

        // Partículas
        const particleContainerAuth = document.getElementById('particle-container-auth');
        const particleContainerGame = document.getElementById('particle-container-game');

        // Funções de Partículas (do seu index.html original)
        function createParticle(container) {
            const particle = document.createElement('div');
            particle.classList.add('particle');
            const size = Math.random() * 3 + 1; // 1px to 4px
            particle.style.width = `${size}px`;
            particle.style.height = `${size}px`;
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.top = `${Math.random() * 100}%`;
            particle.style.animationDuration = `${Math.random() * 3 + 2}s`; // 2 to 5 seconds
            particle.style.animationDelay = `${Math.random() * 0}s`; // Start immediately or with a slight delay
            container.appendChild(particle);

            // Remover a partícula após a animação para evitar acúmulo
            particle.addEventListener('animationend', () => {
                particle.remove();
            });
        }

        function generateParticles(container, count) {
            if (!container) return;
            for (let i = 0; i < count; i++) {
                createParticle(container);
            }
        }

        // --- Funções de Autenticação (do seu auth.js) ---
        async function registerUser(username, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (response.ok) {
                    showOverlayMessage(data.message, 'success');
                    // Opcional: Redirecionar para login após registro ou preencher campos
                    loginUsernameInput.value = username;
                    loginPasswordInput.value = ''; // Limpa senha
                    showLoginLink.click(); // Volta para a tela de login
                } else {
                    showOverlayMessage(data.message || 'Erro no registro.', 'error');
                }
            } catch (error) {
                console.error('Erro de rede no registro:', error);
                showOverlayMessage('Erro de conexão. Tente novamente.', 'error');
            }
        }

        async function loginUser(username, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await response.json();
                if (response.ok) {
                    localStorage.setItem('token', data.token);
                    localStorage.setItem('username', data.username);
                    showOverlayMessage('Login bem-sucedido!', 'success');
                    checkAuth(); // Verifica e mostra a seção do jogo
                } else {
                    showOverlayMessage(data.message || 'Credenciais inválidas.', 'error');
                }
            } catch (error) {
                console.error('Erro de rede no login:', error);
                showOverlayMessage('Erro de conexão. Tente novamente.', 'error');
            }
        }

        function logoutUser() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            showOverlayMessage('Sessão encerrada.', 'info');
            checkAuth(); // Volta para a tela de login
        }

        // --- Funções do Jogo (do seu game.js) ---

        // Atualiza os displays do HUD e monitor
        function updateGameState(state) {
            usernameDisplay.textContent = state.username;
            lulaCoins = state.lulaCoins;
            lulaCoinsDisplay.textContent = lulaCoins.toFixed(2);
            level = state.level;
            levelDisplay.textContent = level;
            minerValue = state.minerValue; // Certifique-se que o backend envia isso
            totalHashrate = state.totalHashrate;
            hashrateDisplay.textContent = totalHashrate.toFixed(2);
            inventory = state.inventory;
            placedGpus = state.placedGpus;

            // Atualiza monitor de texto
            monitorText.textContent = `
Lula Coin Miner OS v1.0
Booting...
Connection: OK
Status: Online

Hashrate: ${totalHashrate.toFixed(2)} H/s
Balance: ${lulaCoins.toFixed(2)} LC
User: ${state.username}
Level: ${level}
            `;

            // Renderiza as GPUs nos racks
            renderPlacedGpus();
            // Atualiza o inventário se o modal estiver aberto
            if (inventoryModal.style.display === 'flex') {
                renderInventory(document.querySelector('#inventoryModal .category-buttons button.active')?.dataset.category || 'gpus');
            }
            // Atualiza o rig manager se o modal estiver aberto
            if (rigManagerModal.style.display === 'flex') {
                renderRigManager();
            }
        }

        // Função para buscar o estado do jogo do backend
        async function fetchGameState() {
            const token = localStorage.getItem('token');
            if (!token) {
                // showOverlayMessage('Sessão expirada ou não logado. Faça login novamente.', 'error');
                // logoutUser(); // Força o logout se não há token
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/game/state`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateGameState(data);
                } else if (response.status === 401) {
                    // Token inválido ou expirado
                    showOverlayMessage('Sessão expirada. Faça login novamente.', 'error');
                    logoutUser();
                } else {
                    const errorData = await response.json();
                    console.error('Erro ao obter estado do jogo:', errorData.message || response.statusText);
                    showOverlayMessage(errorData.message || 'Erro ao carregar o jogo.', 'error');
                }
            } catch (error) {
                console.error('Erro ao obter estado do jogo:', error);
                // showOverlayMessage('Erro de conexão ao carregar o jogo.', 'error');
            }
        }

        async function mineLulaCoins() {
            const token = localStorage.getItem('token');
            if (!token) {
                showOverlayMessage('Faça login para minerar!', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/game/mine`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    lulaCoins = data.lulaCoins;
                    lulaCoinsDisplay.textContent = lulaCoins.toFixed(2);
                    // Adicionar efeito visual de mineração
                    createParticle(minerButton, 5); // Adicionei um container para as partículas de clique
                } else {
                    showOverlayMessage(data.message || 'Erro ao minerar.', 'error');
                }
            } catch (error) {
                console.error('Erro ao minerar:', error);
                showOverlayMessage('Erro de conexão ao minerar.', 'error');
            }
        }

        async function buyItem(itemId, itemType) {
            const token = localStorage.getItem('token');
            if (!token) return showOverlayMessage('Faça login para comprar!', 'error');

            try {
                const response = await fetch(`${API_BASE_URL}/api/game/buy`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ itemId, itemType })
                });
                const data = await response.json();
                if (response.ok) {
                    showOverlayMessage(data.message, 'success');
                    updateGameState(data); // Atualiza todo o estado
                } else {
                    showOverlayMessage(data.message || 'Erro ao comprar.', 'error');
                }
            } catch (error) {
                console.error('Erro ao comprar item:', error);
                showOverlayMessage('Erro de conexão ao comprar.', 'error');
            }
        }

        async function placeGpu(gpuId, inventoryIndex, slotId) {
            const token = localStorage.getItem('token');
            if (!token) return showOverlayMessage('Faça login para colocar GPUs!', 'error');

            try {
                const response = await fetch(`${API_BASE_URL}/api/game/place-gpu`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ gpuId, inventoryIndex, slotId })
                });
                const data = await response.json();
                if (response.ok) {
                    showOverlayMessage(data.message, 'success');
                    updateGameState(data);
                    cancelPlacement(); // Esconde a barra de seleção
                } else {
                    showOverlayMessage(data.message || 'Erro ao colocar GPU.', 'error');
                }
            } catch (error) {
                console.error('Erro ao colocar GPU:', error);
                showOverlayMessage('Erro de conexão ao colocar GPU.', 'error');
            }
        }

        async function removeGpu(slotId) {
            const token = localStorage.getItem('token');
            if (!token) return showOverlayMessage('Faça login para remover GPUs!', 'error');

            try {
                const response = await fetch(`${API_BASE_URL}/api/game/remove-gpu`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ slotId })
                });
                const data = await response.json();
                if (response.ok) {
                    showOverlayMessage(data.message, 'success');
                    updateGameState(data);
                } else {
                    showOverlayMessage(data.message || 'Erro ao remover GPU.', 'error');
                }
            } catch (error) {
                console.error('Erro ao remover GPU:', error);
                showOverlayMessage('Erro de conexão ao remover GPU.', 'error');
            }
        }

        async function sellItem(itemType, itemIndex) {
            const token = localStorage.getItem('token');
            if (!token) return showOverlayMessage('Faça login para vender itens!', 'error');

            try {
                const response = await fetch(`${API_BASE_URL}/api/game/sell-item`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ itemType, itemIndex })
                });
                const data = await response.json();
                if (response.ok) {
                    showOverlayMessage(data.message, 'success');
                    updateGameState(data);
                } else {
                    showOverlayMessage(data.message || 'Erro ao vender item.', 'error');
                }
            } catch (error) {
                console.error('Erro ao vender item:', error);
                showOverlayMessage('Erro de conexão ao vender item.', 'error');
            }
        }

        async function withdrawLulaCoins(e) {
            e.preventDefault();
            const token = localStorage.getItem('token');
            if (!token) return showOverlayMessage('Faça login para sacar!', 'error');

            const amount = parseFloat(withdrawAmountInput.value);

            try {
                const response = await fetch(`${API_BASE_URL}/api/game/withdraw`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ amount })
                });
                const data = await response.json();
                if (response.ok) {
                    showOverlayMessage(data.message, 'success');
                    updateGameState(data);
                    closeModal(withdrawModal);
                    withdrawAmountInput.value = ''; // Limpa o campo
                } else {
                    showOverlayMessage(data.message || 'Erro ao sacar.', 'error');
                }
            } catch (error) {
                console.error('Erro ao sacar Lula Coins:', error);
                showOverlayMessage('Erro de conexão ao sacar.', 'error');
            }
        }

        // Renderiza as GPUs nos slots do rack
        function renderPlacedGpus() {
            rackSlots.forEach(slot => {
                const slotId = `${slot.dataset.rack}-slot-${slot.dataset.slot}`;
                slot.innerHTML = ''; // Limpa o slot
                slot.classList.remove('occupied');

                if (placedGpus[slotId]) {
                    const gpu = placedGpus[slotId];
                    const img = document.createElement('img');
                    img.src = gpu.img;
                    img.alt = gpu.name;
                    slot.appendChild(img);
                    slot.classList.add('occupied');
                    slot.dataset.gpuId = gpu.id; // Para referência futura, se necessário
                }
            });
        }

        // Lógica para abrir/fechar modais
        function openModal(modalElement) {
            modalElement.style.display = 'flex';
        }

        function closeModal(modalElement) {
            modalElement.style.display = 'none';
        }

        // Renderiza a loja
        async function renderShop(category) {
            shopItemsList.innerHTML = ''; // Limpa a lista
            let itemsToRender = [];

            // Mock de itens da loja (precisa ser atualizado para buscar do backend se shopItems mudar)
            const shopData = { // Usando um mock temporário aqui, idealmente viria do backend
                gpus: [
                    { id: "basic_gpu", name: "GPU Básica", hashrate: 10, cost: 100, img: "https://via.placeholder.com/80x80/FF0000/FFFFFF?text=GPU1" },
                    { id: "mid_gpu", name: "GPU Intermediária", hashrate: 50, cost: 450, img: "https://via.placeholder.com/80x80/00FF00/000000?text=GPU2" },
                    { id: "pro_gpu", name: "GPU Profissional", hashrate: 200, cost: 1500, img: "https://via.placeholder.com/80x80/0000FF/FFFFFF?text=GPU3" }
                ],
                upgrades: [
                    { id: "power_supply_1", name: "Fonte de Energia I", effect: "+10% Hashrate", cost: 300, img: "https://via.placeholder.com/80x80/FFFF00/000000?text=PSU1" },
                    { id: "cooling_fan_1", name: "Ventoinha de Resfriamento I", effect: "+5% Hashrate", cost: 200, img: "https://via.placeholder.com/80x80/00FFFF/000000?text=FAN1" }
                ]
            };


            if (category === 'gpus') {
                itemsToRender = shopData.gpus;
            } else if (category === 'upgrades') {
                itemsToRender = shopData.upgrades;
            }

            itemsToRender.forEach(item => {
                const card = document.createElement('div');
                card.classList.add('item-card');
                card.innerHTML = `
                    <img src="${item.img}" alt="${item.name}">
                    <h4>${item.name}</h4>
                    ${item.hashrate ? `<p class="hashrate">+${item.hashrate} H/s</p>` : ''}
                    ${item.effect ? `<p>${item.effect}</p>` : ''}
                    <p class="cost">${item.cost.toFixed(2)} Lula Coins</p>
                    <button data-item-id="${item.id}" data-item-type="${category}">Comprar</button>
                `;
                shopItemsList.appendChild(card);
            });

            // Adiciona listeners aos botões de compra
            shopItemsList.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', () => {
                    buyItem(button.dataset.itemId, button.dataset.itemType);
                });
            });
        }

        // Renderiza o inventário
        function renderInventory(category) {
            inventoryItemsList.innerHTML = ''; // Limpa a lista
            let itemsToRender = [];
            let currentInventory = inventory[category] || []; // Garante que é um array

            if (category === 'gpus') {
                itemsToRender = currentInventory;
            } else if (category === 'upgrades') {
                itemsToRender = currentInventory;
            }

            if (itemsToRender.length === 0) {
                inventoryItemsList.innerHTML = '<p>Nenhum item nesta categoria.</p>';
                return;
            }

            itemsToRender.forEach((item, index) => {
                const card = document.createElement('div');
                card.classList.add('item-card');
                card.innerHTML = `
                    <img src="${item.img}" alt="${item.name}">
                    <h4>${item.name}</h4>
                    ${item.hashrate ? `<p class="hashrate">+${item.hashrate} H/s</p>` : ''}
                    ${item.effect ? `<p>${item.effect}</p>` : ''}
                    <button class="place-sell-btn" data-item-type="${category}" data-item-index="${index}" data-item-id="${item.id}">
                        ${category === 'gpus' ? 'Colocar' : 'Usar'}
                    </button>
                    <button class="sell-btn" data-item-type="${category}" data-item-index="${index}">Vender</button>
                `;
                inventoryItemsList.appendChild(card);
            });

            // Adiciona listeners aos botões de colocar/usar e vender
            inventoryItemsList.querySelectorAll('.place-sell-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const itemType = button.dataset.itemType;
                    const itemIndex = parseInt(button.dataset.itemIndex);
                    const itemId = button.dataset.itemId;

                    if (itemType === 'gpus') {
                        // Inicia o modo de colocação de GPU
                        isPlacingGpu = true;
                        selectedGpuToPlace = { id: itemId, index: itemIndex };
                        openModal(minerSelectionBar); // Mostra a barra de seleção
                        closeModal(inventoryModal); // Fecha o inventário
                        showOverlayMessage('Selecione um slot vazio no rack para colocar a GPU.', 'info');
                    } else {
                        // Lógica para usar upgrades
                        showOverlayMessage('Funcionalidade de "Usar Upgrade" ainda não implementada.', 'info');
                    }
                });
            });

            inventoryItemsList.querySelectorAll('.sell-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const itemType = button.dataset.itemType;
                    const itemIndex = parseInt(button.dataset.itemIndex);
                    sellItem(itemType, itemIndex);
                });
            });
        }

        // Renderiza o Rig Manager
        function renderRigManager() {
            rigSlotsList.innerHTML = ''; // Limpa a lista
            let hasPlacedGpus = false;

            // Itera sobre os slots para mostrar as GPUs colocadas
            for (const slotId in placedGpus) {
                if (placedGpus.hasOwnProperty(slotId)) {
                    hasPlacedGpus = true;
                    const gpu = placedGpus[slotId];
                    const rigSlotDiv = document.createElement('div');
                    rigSlotDiv.classList.add('rig-slot');
                    rigSlotDiv.innerHTML = `
                        <span>${slotId.replace('-', ' ').replace('slot', 'Slot').replace('rack', 'Rack')}: ${gpu.name} (${gpu.hashrate} H/s)</span>
                        <button data-slot-id="${slotId}">Remover</button>
                    `;
                    rigSlotsList.appendChild(rigSlotDiv);
                }
            }

            if (!hasPlacedGpus) {
                rigSlotsList.innerHTML = '<p>Nenhuma GPU colocada nos racks.</p>';
            }

            // Adiciona listeners aos botões de remover
            rigSlotsList.querySelectorAll('button').forEach(button => {
                button.addEventListener('click', () => {
                    const slotId = button.dataset.slotId;
                    removeGpu(slotId);
                });
            });
        }

        // Lógica para slots de racks (clicar para colocar ou remover)
        function addEventListenersToRackSlots() {
            rackSlots.forEach(slot => {
                slot.addEventListener('click', () => {
                    const slotId = `${slot.dataset.rack}-slot-${slot.dataset.slot}`;

                    if (isPlacingGpu && selectedGpuToPlace) {
                        // Tentando colocar uma GPU
                        if (!placedGpus[slotId]) { // Se o slot estiver vazio
                            placeGpu(selectedGpuToPlace.id, selectedGpuToPlace.index, slotId);
                        } else {
                            showOverlayMessage('Este slot já está ocupado!', 'error');
                        }
                    } else if (placedGpus[slotId]) {
                        // Clicou em um slot ocupado, oferece para remover (ou abrir modal de detalhes)
                        // Por enquanto, apenas para remover
                        showOverlayMessage(`GPU ${placedGpus[slotId].name} no ${slotId}. Use 'Gerenciar Rigs' para remover.`, 'info');
                    } else {
                        // Clicou em um slot vazio sem estar em modo de colocação
                        showOverlayMessage('Selecione uma GPU no inventário para colocá-la aqui.', 'info');
                    }
                });
            });
        }

        // Cancela o modo de colocação de GPU
        function cancelPlacement() {
            isPlacingGpu = false;
            selectedGpuToPlace = null;
            closeModal(minerSelectionBar);
            showOverlayMessage('Colocação de GPU cancelada.', 'info');
        }

        // Funções para controle de modais
        function openShop() {
            openModal(shopModal);
            renderShop('gpus'); // Renderiza GPUs por padrão ao abrir
            shopCategoryButtons.forEach(b => b.classList.remove('active'));
            document.querySelector('#shopModal .category-buttons button[data-category="gpus"]').classList.add('active');
        }

        function closeShop() {
            closeModal(shopModal);
        }

        function openInventory() {
            openModal(inventoryModal);
            renderInventory('gpus'); // Renderiza GPUs por padrão ao abrir
            inventoryCategoryButtons.forEach(b => b.classList.remove('active'));
            document.querySelector('#inventoryModal .category-buttons button[data-category="gpus"]').classList.add('active');
        }

        function closeInventory() {
            closeModal(inventoryModal);
        }

        function openWithdrawModal() {
            withdrawCurrentBalance.textContent = lulaCoins.toFixed(2);
            openModal(withdrawModal);
        }

        function openRigManager() {
            openModal(rigManagerModal);
            renderRigManager();
        }

        function handleShopCategoryClick(e) {
            shopCategoryButtons.forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            renderShop(e.target.dataset.category);
        }

        function handleInventoryCategoryClick(e) {
            inventoryCategoryButtons.forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');
            renderInventory(e.target.dataset.category);
        }


        // Lógica do Terminal
        function appendTerminalOutput(message) {
            const p = document.createElement('p');
            p.textContent = message;
            terminalOutput.appendChild(p);
            terminalOutput.scrollTop = terminalOutput.scrollHeight; // Scroll to bottom
        }

        // --- Inicialização e Controle de Seções ---
        async function checkAuth() {
            const token = localStorage.getItem('token');
            const username = localStorage.getItem('username');

            if (token && username) {
                // Tenta buscar o estado do jogo para validar o token
                try {
                    const response = await fetch(`${API_BASE_URL}/api/game/state`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        updateGameState(data);
                        authSection.style.display = 'none';
                        gameSection.style.display = 'flex'; // Mostra a seção do jogo
                        // Gera partículas do jogo se ainda não estiverem geradas
                        if (particleContainerGame && particleContainerGame.children.length === 0) {
                            generateParticles(particleContainerGame, 30);
                            setInterval(() => createParticle(particleContainerGame), 2000);
                        }
                        return true; // Autenticado e jogo carregado
                    } else {
                        // Token inválido ou expirado no backend
                        showOverlayMessage('Sessão expirada. Faça login novamente.', 'error');
                        localStorage.removeItem('token');
                        localStorage.removeItem('username');
                        authSection.style.display = 'flex';
                        gameSection.style.display = 'none';
                        return false;
                    }
                } catch (error) {
                    console.error('Erro ao verificar autenticação com o backend:', error);
                    showOverlayMessage('Erro de conexão ao verificar sessão.', 'error');
                    localStorage.removeItem('token');
                    localStorage.removeItem('username');
                    authSection.style.display = 'flex';
                    gameSection.style.display = 'none';
                    return false;
                }
            } else {
                // Não há token salvo, mostra a tela de login
                authSection.style.display = 'flex';
                gameSection.style.display = 'none';
                return false;
            }
        }

        // Função para inicializar todos os listeners de eventos (chamada apenas uma vez)
        function initializeEventListeners() {
            // Listeners de Autenticação
            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = loginUsernameInput.value;
                    const password = loginPasswordInput.value;
                    await loginUser(username, password);
                });
            }

            if (registerForm) {
                registerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = registerUsernameInput.value;
                    const password = registerPasswordInput.value;
                    await registerUser(username, password);
                });
            }

            if (showRegisterLink) {
                showRegisterLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('login-form-container').style.display = 'none';
                    document.getElementById('register-form-container').style.display = 'block';
                    loginMessageDisplay.textContent = '';
                    loginUsernameInput.value = '';
                    loginPasswordInput.value = '';
                });
            }

            if (showLoginLink) {
                showLoginLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.getElementById('login-form-container').style.display = 'block';
                    document.getElementById('register-form-container').style.display = 'none';
                    registerMessageDisplay.textContent = '';
                    registerUsernameInput.value = '';
                    registerPasswordInput.value = '';
                });
            }

            // Listeners do Jogo (apenas se os elementos existirem, pois podem estar hidden)
            if (minerButton) minerButton.addEventListener('click', mineLulaCoins);
            if (openShopBtn) openShopBtn.addEventListener('click', openShop);
            if (closeShopBtn) closeShopBtn.addEventListener('click', () => closeModal(shopModal)); // Usando closeModal
            if (openInventoryBtn) openInventoryBtn.addEventListener('click', openInventory);
            if (closeInventoryBtn) closeInventoryBtn.addEventListener('click', () => closeModal(inventoryModal)); // Usando closeModal
            if (openRigManagerBtn) openRigManagerBtn.addEventListener('click', openRigManager);
            if (closeRigManagerBtn) closeRigManagerBtn.addEventListener('click', () => closeModal(rigManagerModal));
            if (saqueButton) saqueButton.addEventListener('click', openWithdrawModal);
            if (closeWithdrawBtn) closeWithdrawBtn.addEventListener('click', () => closeModal(withdrawModal));
            if (logoutButton) logoutButton.addEventListener('click', logoutUser);
            if (cancelSelectionBtn) cancelSelectionBtn.addEventListener('click', cancelPlacement);
            if (withdrawForm) withdrawForm.addEventListener('submit', withdrawLulaCoins);

            // Listeners para cliques em categorias de loja e inventário
            shopCategoryButtons.forEach(button => {
                button.addEventListener('click', handleShopCategoryClick);
            });
            inventoryCategoryButtons.forEach(button => {
                button.addEventListener('click', handleInventoryCategoryClick);
            });

            // Lógica do Terminal
            if (terminalInput) {
                terminalInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const command = terminalInput.value.trim();
                        appendTerminalOutput(`[INPUT] ${command}`);
                        terminalInput.value = '';

                        if (command.toLowerCase() === 'help') {
                            appendTerminalOutput('Comandos disponíveis: help, clear, status');
                        } else if (command.toLowerCase() === 'clear') {
                            terminalOutput.innerHTML = '';
                            appendTerminalOutput('Terminal limpo.');
                        } else if (command.toLowerCase() === 'status') {
                            appendTerminalOutput(`Lula Coins: ${lulaCoins.toFixed(2)}`);
                            appendTerminalOutput(`Hashrate Total: ${totalHashrate.toFixed(2)} H/s`);
                            appendTerminalOutput(`Nível do Minerador: ${level}`);
                        } else {
                            appendTerminalOutput(`Comando não reconhecido: ${command}`);
                        }
                    }
                });
            }

            // Adiciona listeners para os slots do rack
            addEventListenersToRackSlots();

            // Fechar modais ao clicar fora (exceto a barra de seleção de mineradores)
            window.onclick = function(event) {
                if (event.target == shopModal) { closeModal(shopModal); }
                if (event.target == inventoryModal) { closeModal(inventoryModal); }
                if (event.target == withdrawModal) { closeModal(withdrawModal); }
                if (event.target == rigManagerModal) { closeModal(rigManagerModal); }
                // minerSelectionBar não deve fechar ao clicar fora, apenas via botão "Cancelar"
            };
        }


        // Loop de mineração passiva (a cada 5 segundos) e atualização de estado
        setInterval(async () => {
            if (localStorage.getItem('token')) { // Só busca estado se estiver logado
                await fetchGameState();
            }
        }, 5000); // A cada 5 segundos

        // Inicialização Principal ao carregar o DOM
        document.addEventListener('DOMContentLoaded', () => {
            initializeEventListeners(); // Inicializa todos os listeners uma vez
            checkAuth(); // Verifica o token ao carregar a página e mostra a UI correta

            // Gera partículas nas seções apropriadas
            if (particleContainerAuth) {
                generateParticles(particleContainerAuth, 50);
                setInterval(() => createParticle(particleContainerAuth), 1000);
            }
            // As partículas do game container serão geradas dentro de checkAuth()
            // quando a seção do jogo for exibida e confirmada a autenticação.
        });
    </script>
</body>
</html>
